# 函数和程序结构

函数将复杂的计算分割，使代码更清晰。合适地使用函数，可将不必要的细节隐藏，也可使程序修改更容易。

C程序通常是由许多小型函数构成，并可写在多个源文件内。源文件可分开编译，一起加载，或者同已编译的库程序一起加载，这点上各系统有差异。

如果函数声明和定义保持一致，可利用编译器检查错误。此外，如果函数参数声明适当，可实现自动类型转换？。

外部变量不能重复定义。数组和结构体自动变量定义时可初始化。

预处理命令得到改善，可实现条件编译，可利用宏参数创建字符串，宏扩展也更加容易控制？。

## 函数基础

以一个程序实例讲解。此程序类似UNIX系统命令grep，显示文本中含特定字符串的行，伪代码：

```c
while(there is another line)
    if (the line contains the pattern)
        print it
```

可将此程序分割为3个函数："there is another line" -> getline，"print it" -> printf，"the line contains the pattern"。者样分割后，可将不相干的细节隐藏在函数中，如果修改程序的特定功能，只需修改相应函数。

是否包含指定字符串的函数定义为strindex(s, t)，如果s包含t，返回s中开始包含的索引，如果不包含返回-1（字符串索引从0开始，所以失败返回-1是好的选择）。标准库string.h中也有同样功能的函数strstr，不过返回的是指针。

-   [ex4-1](ex/4-1.c)：重新定义strindex(s, t)，也是返回字符串t在s中的位置，如果不包含，返回-1。不同的是，从s的右边开始寻找。

## 函数返回值

到目前所见函数只返回2种类型，int和viod。函数可返回其它所有类型，不如标准库math.h中的函数如sqrt，sin和cos等都返回double类型。下面以一个简化版的atof(s)函数为例，将字符串转换为double类型，可处理正负号，小数点后面部分。此版本会占用比实际需求更大的内存，标准库stdlib.h中有同名函数atof(s)。

```c
#include <ctype.h>
#include <stdio.h>

#define MAX_LINE 100

int main(void) {
  double sum, atof(char s[]);
  char line[MAX_LINE];
  int get_line(char line[], int max);

  sum = 0;
  while (get_line(line, MAX_LINE) > 0) {
    printf("\t%g\n", sum += atof(line));
  }
  return 0;
}

// double atof(char s[]) {
//   double val, power;
//   int i, sign;
//
//   // 跳过空格
//   for (i = 0; isspace(s[i]); i++)
//     ;
//
//   // 确定正负号
//   sign = (s[i] == '-') ? -1 : 1;
//
//   if (s[i] == '-' || s[i] == '+') {
//     i++;
//   }
//
//   // 处理小数点前面部分
//   for (val = 0.0; isdigit(s[i]); i++) {
//     val = val * 10.0 + (s[i] - '0');
//   }
//
//   //处理小数点后面部分
//   if (s[i] == '.') {
//     i++;
//   }
//   for (power = 1.0; isdigit(s[i]); i++) {
//     val = val * 10.0 + (s[i] - '0');
//     power *= 10.0;
//   }
//
//   // 返回
//   return (val * sign) / power;
// }
```

`double sum, atof(char [])`声明sum为double类型，atof有一个参数类型为char\[]，并返回double类型。

atof函数的声明和定义必须保持一致。如果atof函数和main函数在同一源文件内，且定义与声明不一致，编译器会报错。如果二者处于不同源文件内，分开编译，编译器不会报错，main函数会将其返回值默认为int类型，造成语义错误。

如果函数没有原型声明，返回值会在第一次使用时默认声明，如`sum += atof(line)`，默认atof函数返回int类型，且其参数类型不确定。如果声明为`double atof()`，即没有任何参数类型声明，编译器不会检查任何参数，所以如果函数没有参数，参数声明为void，`double atof(void)`。

可以在上面atof函数的基础山定义atoi函数（返回整型）：

```c
int atoi(char line[]) { return (int)atof(line); }
```

由于定义atoi时声明返回值为int类型，即使不使用强制类型转换也会默认返回int类型，但编译器会警告，所以最好需使用强制转换。

-   [ex4-2](ex/4-2.c)： 改进atof函数，使其支持科学计数法，如`123.45e-6`，"e"可以是大写“E”。

test kali linux
## 外部变量

## 作用域规则

## 头文件

## 静态变量

## 寄存器变量

## 块结构

## 变量初始化

## 预处理命令

### 文件引入

### 宏替换

### 条件引入
